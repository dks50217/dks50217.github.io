import{q as O,s as E,a as I,d as x,v as p,x as g,J as b,K as T,F as o,Q as H,H as f,G as _,R as P,Z as w,T as B,S as k,ao as N,at as F,au as G,w as z,j as D,z as Q,C as U,D as J,E as R,f as h,N as V,O as q,P as Y,L as K}from"./index.js";import{p as v,d as W,g as Z,b as X}from"./xivapi.js";import{U as C}from"./util.js";import{_ as S}from"./_plugin-vue_export-helper.js";const L=["tank","healer","dps","crafter","gatherer","none"],M=[24283,24284,24285,24286,24287,24288,24289,24290,24294,24295,24296,24297,24298,24299,24300,24301,24302,24303,24304,24305,24306,24307,24309,24310,24311,24312,24313,24315,24316,24317,24318],j=O("castingMonitor",{state:()=>{var t;return{castData:E({}),playerId:I(""),focusTargetId:I(""),partyData:[],config:{duration:Number(((t=v)==null?void 0:t.duration)||25)},lastPush:Date.now()}},getters:{partyDataFormatted(t){return t.partyData.sort((e,l)=>L.indexOf(C.jobToRole(C.jobEnumToJob(e.job)))-L.indexOf(C.jobToRole(C.jobEnumToJob(l.job))))},focusTargetCastArr(t){var e;return((e=t.castData)==null?void 0:e[t.focusTargetId])??[]}},actions:{testAction(){const t=M[Math.floor(Math.random()*M.length)];this.pushAction(Date.now(),14,"賢者技能隨機",this.focusTargetId,t,1),setTimeout(()=>{this.pushAction(Date.now(),15,"賢者技能隨機",this.focusTargetId,t)},1e3)},testItem(){this.pushAction(Date.now(),15,"item_11c7",this.focusTargetId,parseInt("20011C7",16))},testItemHQ(){this.pushAction(Date.now(),15,"item_f5407",this.focusTargetId,parseInt("20F5407",16))},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"測試張三",job:24,inParty:!0,src:""},{id:"10000002",name:"測試李四",job:25,inParty:!0,src:""},{id:"10000004",name:"測試王五",job:19,inParty:!0,src:""},{id:"10000005",name:"測試趙六",job:23,inParty:!0,src:""},{id:"10000006",name:"測試孫七",job:39,inParty:!0,src:""},{id:"10000007",name:"測試周八",job:40,inParty:!0,src:""},{id:"10000008",name:"測試吳九",job:37,inParty:!0,src:""},{id:"10000009",name:"測試鄭十",job:38,inParty:!0,src:""}]:[]})},async pushAction(t,e,l,a,d,c){var y;const u=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((y=v)==null?void 0:y.energySaving);if(this.partyData.length===0&&a===this.playerId||u&&a===this.focusTargetId||!u&&this.partyData.length>0&&this.partyData.find(i=>i.id===a)){let i,r=!1;/^(?:item|mount)_/.test(l)?(d=parseInt(l.replace(/^.+_/,""),16),d>983040&&(d=parseInt(d.toString().slice(-5),10),r=!0),i=l.replace(/_.+$/,"")):i="action",this.castData[a]||(this.castData[a]=[]);const m=Symbol();this.castData[a].push({time:t,logLine:e,src:"",class:"",key:m,APIData:{}}),this.lastPush=Date.now();const n=this.castData[a].find(s=>s.key===m);if(setTimeout(()=>{var s;(s=this.castData[a])==null||s.splice(this.castData[a].indexOf(n),1)},(c||this.config.duration)*1e3),/^unknown_/.test(l))n.src="https://cafemaker.wakingsands.com/i/000000/000405.png",n.class="action action-category-0";else if(d<1e5){const s=await W(i,d,["ID","Icon","ActionCategoryTargetID","Name","Description"]);if(n.APIData=s,n.src=await Z((s==null?void 0:s.Icon)??"",r),i==="action"?n.class=`action action-category-${s==null?void 0:s.ActionCategoryTargetID}`:i==="item"?n.class="item"+(r?"HQ":""):i==="mount"&&(n.class="mount"),s.ActionCategoryTargetID===2||s.ActionCategoryTargetID===3){const A=this.castData[a].filter($=>/action-category-[23]/.test($.class)&&$.logLine!==14).at(-2);A&&(n.GCDCast=((n.time-A.time)/1e3).toFixed(2),parseFloat(n.GCDCast)>=2.55&&(n.GCDClass="wasted"))}}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.parse(t.line[1]),14,t.line[5],t.line[2],parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.parse(t.line[1]),15,t.line[5],t.line[2],parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty);for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(l=>l.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){var e;t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((e=v)==null?void 0:e.syncFocusWS)&&callOverlayHandler({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},handleBroadcastMessage(t){t.source==="castMonitorOverlay"&&t.msg.targetId&&(this.focusTargetId=t.msg.targetId)}}}),tt=t=>(F("data-v-263363c2"),t=t(),G(),t),et={"w-100vw":"",flex:"~ nowrap",class:"main"},at=["data-casterId"],st={class:"elhover"},nt=["innerHTML"],ot=["src"],rt=tt(()=>_("img",{class:"frame",loading:"lazy"},null,-1)),it=x({__name:"main",setup(t){const e=j(),l=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(v.displayAA)),a=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(v.displayGCDSpace));return(d,c)=>{const u=N;return p(),g("div",et,[(p(!0),g(b,null,T(o(e).castData,(y,i)=>(p(),g("div",{key:i,"data-casterId":i},[(p(!0),g(b,null,T(y,r=>(p(),H(u,{"raw-content":"",placement:"right-start",effect:"dark",transition:"",teleported:!1,"popper-class":"el-tooltip","show-arrow":!1,key:r.key},{content:f(()=>{var m;return[_("div",st,[_("strong",null,P(r.APIData.Name),1),_("div",{innerHTML:(m=r.APIData)==null?void 0:m.Description,style:{"white-space":"pre-line"}},null,8,nt)])]}),default:f(()=>[_("div",{class:w(`images ${r.class} logLine${r.logLine} displayAA${o(l)} displayGCD${o(a)}`),style:B(`--animeDuration: ${o(e).config.duration}s;opacity:${+(o(e).focusTargetId===i)}`)},[_("img",{src:r.src,class:"action-icon",height:"40",loading:"lazy"},null,8,ot),rt,o(a)===1?(p(),g("span",{key:0,class:w(["GCDCast",r.GCDClass])},P((r==null?void 0:r.GCDCast)??""),3)):k("",!0)],6)]),_:2},1024))),128))],8,at))),128))])}}});const lt=S(it,[["__scopeId","data-v-263363c2"]]),ct={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},dt=["onClick"],ut={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},pt=["src"],ht=x({__name:"header",setup(t){var a;const e=j();z(()=>{e.partyData.forEach(async d=>{d.src=await X(d.job)})});const l=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((a=v)==null?void 0:a.showHeader);return(d,c)=>o(l)?(p(),g("div",ct,[(p(!0),g(b,null,T(o(e).partyDataFormatted,(u,y)=>(p(),g("button",{key:y,onClick:i=>o(e).handleClickChangeTarget(u.id),class:w(["job-lists",o(e).focusTargetId===u.id?"job-lists-focus":""]),"p-0":"","m-0":""},[_("div",ut,[_("img",{src:u.src,style:{height:"1.25em"},loading:"lazy"},null,8,pt),D(" "+P(o(C).nameToFullName(o(C).jobEnumToJob(u.job)).simple2),1)])],10,dt))),128))])):k("",!0)}});const ft={class:"common-layout"},gt={key:0},yt=x({__name:"castingMonitor",setup(t){const e=j(),l=location.href.indexOf("localhost")>-1;Q(()=>{addOverlayListener("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),addOverlayListener("LogLine",e.handleLogLine),addOverlayListener("PartyChanged",e.handlePartyChanged),addOverlayListener("BroadcastMessage",e.handleBroadcastMessage),startOverlayEvents()}),U(()=>{removeOverlayListener("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),removeOverlayListener("LogLine",e.handleLogLine),removeOverlayListener("PartyChanged",e.handlePartyChanged),removeOverlayListener("BroadcastMessage",e.handleBroadcastMessage)});const a=I(!1);return setInterval(()=>{a.value=Date.now()-e.lastPush<e.config.duration*2*1e3},1e3),(d,c)=>{const u=ht,y=V,i=lt,r=q,m=Y,n=K;return J((p(),g("div",ft,[h(m,{"items-center":""},{default:f(()=>[h(y,{class:"header-layout"},{default:f(()=>[h(u)]),_:1}),h(r,{"p-0":""},{default:f(()=>[h(i)]),_:1})]),_:1}),l?(p(),g("footer",gt,[h(n,{onClick:c[0]||(c[0]=s=>o(e).testParty(!0))},{default:f(()=>[D("虛假小隊")]),_:1}),h(n,{onClick:c[1]||(c[1]=s=>o(e).testParty(!1))},{default:f(()=>[D("單人")]),_:1}),h(n,{onClick:c[2]||(c[2]=s=>o(e).testAction())},{default:f(()=>[D("Action")]),_:1}),h(n,{onClick:c[3]||(c[3]=s=>o(e).testItem())},{default:f(()=>[D("Item")]),_:1}),h(n,{onClick:c[4]||(c[4]=s=>o(e).testItemHQ())},{default:f(()=>[D("ItemHQ")]),_:1})])):k("",!0)],512)),[[R,o(a)]])}}});const vt=S(yt,[["__scopeId","data-v-8eff4fb0"]]);export{vt as default};
